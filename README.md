
# Neuro-Link (华西神经专病AI数字医院)

## 1. 项目愿景 (Project Vision)
本项目致力于构建一个**符合华西医院神经内科临床标准**的 C 端数字医疗服务平台。
它不仅仅是一个问诊工具，而是集成了**AI CDSS（临床决策支持系统）**、**专业医学量表**、**数字疗法（游戏/监测）**以及**医联体分级诊疗**的全周期慢病管理系统。我们的目标是通过技术手段，将优质的医疗资源标准化、数字化，服务于偏头痛、癫痫及认知障碍患者。

---

## 2. 代码架构索引 (Source Map)

### Core Logic & State (核心逻辑与状态)
*   **`App.tsx`**: 应用主入口。负责路由分发、全局状态初始化及 Deep Link 监听。
*   **`context/AppContext.tsx`**: 全局状态容器。负责**用户数据脱敏 (Masking)**、**模拟 AES 加密存储**及多家庭成员档案管理。
*   **`types.ts`**: 类型定义库。包含详细的**专病档案结构 (Epilepsy/Cognitive Profile)**、商业化权益枚举及用户角色定义。

### Services & Hooks (服务层)
*   **`services/geminiService.ts`**: AI 核心服务。目前采用**Mock 状态机**模拟华西 CDSS 问诊逻辑，包含术语库清洗与 NLP 字段提取模拟。
*   **`hooks/usePayment.ts`**: 商业化逻辑核心。包含**个性化套餐推荐算法**、优惠券核销逻辑、硬件租期价格计算逻辑。
*   **`hooks/useTriage.ts`**: 分诊逻辑 Hook。负责串联 AI 分析结果与转诊系统的交互。
*   **`hooks/useLBS.ts`**: 位置服务 Hook。模拟获取用户地理位置并计算距最近医联体医院的距离。

### Business Components (核心医学业务组件)
> 位于 `components/business/`，承载高内聚的医学/商业规则。
*   **`business/headache/DigitalPrescription.tsx`**: **[数字处方]**。负责处方有效期校验、华西医师白名单鉴权、动态生活方式干预计算。
*   **`business/epilepsy/WaveMonitor.tsx`**: **[脑电监测]**。负责 60FPS 高保真脑电波形绘制，包含随机**痫样放电 (Spike Wave)** 的数学模拟逻辑。
*   **`business/ReferralSystem.tsx`**: **[转诊系统]**。负责转诊指征的 CDSS 校验（字数/关键词拦截）及生成防伪二维码通行证。
*   **`business/payment/PaywallModal.tsx`**: **[支付墙]**。负责权益对比展示、优惠券选择及模拟支付网关交互。

### UI Views (视图层)
*   **`components/ChatView.tsx`**: AI 问诊页。实现多轮对话 UI、**专病切换 (Tab)** 及基于 LocalStorage 的**上下文持久化**。
*   **`components/HomeView.tsx`**: 首页仪表盘。实现**动态风险水波球**、**AI 智能推荐卡片**及各专病状态卡片。
*   **`components/AssessmentView.tsx`**: 量表评估页。适配华西修订版 **MIDAS / AD8** 量表，包含进度条与评分逻辑。
*   **`components/ReportView.tsx`**: 报告页。根据风险评分渲染红/黄/绿分级报告，并提供干预入口。
*   **`components/HealthServices.tsx`**: 专病服务详情页容器。聚合了数字处方、脑电监测等子模块。
*   **`components/ServiceMarketplace.tsx`**: 服务商城与租赁台。实现**硬件租赁流程**（租期选择、押金计算、物流模拟）。
*   **`components/CognitiveGames.tsx`**: 认知训练游戏。包含“视觉记忆”与“舒尔特方格”，用于 AD 患者康复。

### Shared Components (通用组件)
*   **`components/Layout.tsx`**: 基础布局。处理顶部导航栏与刘海屏安全区适配。
*   **`components/Button.tsx`**: 通用按钮。

---

## 3. 业务功能现状 (Audit Matrix)

| 核心功能模块 | 子功能点 | 完成度状态 | 备注 (Audit Note) |
| :--- | :--- | :--- | :--- |
| **AI 问诊** | 多轮对话交互 | ✅ 已实现 | 包含打字机效果、选项交互 |
| | 专病逻辑分流 | ✅ 已实现 | 覆盖头痛/癫痫/认知三类话术 |
| | **真实 LLM 接入** | ⚠️ **Mock** | 目前为基于规则的硬编码逻辑，未接真实 API |
| **数字处方** | 动态内容展示 | ✅ 已实现 | 根据诱因权重重排生活建议 |
| | **合规校验** | ✅ 已实现 | 包含有效期、医师签名、过期变灰逻辑 |
| **诱因雷达** | 风险计算模型 | ✅ 已实现 | 基于权重矩阵计算风险分 |
| | IoT 数据接入 | ⚠️ **Mock** | 诱因通过手动点击模拟，非真实传感器数据 |
| **脑电监测** | 波形渲染 | ✅ 已实现 | 高性能 SVG 渲染，含病理波模拟 |
| | 蓝牙设备连接 | ⚠️ **Mock** | 无真实蓝牙通信代码 |
| **转诊系统** | CDSS 规则校验| ✅ 已实现 | 拦截不合规转诊理由 |
| | 通行证生成 | ✅ 已实现 | 包含伪二维码算法 |
| **商业化** | 支付流程 | ✅ 已实现 | 含优惠券、SKU计算、异常重试 |
| | 硬件租赁 | ✅ 已实现 | 含押金、租期、物流状态机 |

---

## 4. 商业化埋点清单 (Commercial Checkpoints)

| 触发位置 | 触发条件 | 关联 Package (FeatureKey) | 表现形式 |
| :--- | :--- | :--- | :--- |
| **HomeView** | 风险分 < 80 且非 VIP | `ICE_BREAKING_MIGRAINE` | 顶部高亮“1元解锁”金条 |
| **HomeView** | AI 智能推荐卡片 | 动态计算 (如 `VIP_EPILEPSY`) | 首页信息流大卡片 |
| **DigitalPrescription** | 点击“立即解锁”/查看处方 | `ICE_BREAKING_MIGRAINE` | 处方卡片上的遮罩锁 |
| **EpilepsyService** | 查看历史监测数据 | `VIP_EPILEPSY` | 列表项遮罩 |
| **CognitiveService** | 点击“高阶认知训练” | `VIP_COGNITIVE` | 底部 Banner |
| **ServiceMarketplace**| 租赁“癫痫守护包” | `VIP_EPILEPSY` | 包含硬件租赁的复合商品 |
| **ProfileView** | 点击“导出病历 PDF” | `VIP_MIGRAINE` | 按钮触发 |

---

## 5. 变更日志 (Change Log)

### [2026-XX-XX] - [CDSS 问诊分流逻辑修复]
- **动态风险计算**：
  - 在 `geminiService.ts` 中引入 `estimatedRisk` 实时评分机制。
  - AI 现在会根据用户的症状描述（如“剧烈头痛”、“每天发作”、“抽搐”）自动累加风险分值，不再是黑盒状态。
- **报告页准确性修复**：
  - 修正了 `ChatView.tsx` 中 `handleSkip` 的逻辑，不再无脑传递 0 分。
  - 即使选择“跳过付费测评”，系统也会基于问诊过程中的初步判断（estimatedRisk）生成风险提示，确保了高危患者能看到红色预警报告。

### [2026-XX-XX] - [ChatView 体验优化]
- **交互瘦身**：
  - 移除了“信息已提交，正在分析...”的反馈 Toast。
  - 理由：此 Toast 遮挡视线且打断对话心流，移除后用户发送消息的体验更加顺滑，符合主流 IM 的操作习惯。

### [2026-XX-XX] - [全链路回归测试 & 体验修复]
- **性能优化 (CognitiveGames)**：
  - 重构音频引擎为 **Singleton** 单例模式，解决了频繁创建 AudioContext 导致的内存泄漏风险。
  - 增加了 `resume()` 自动唤醒逻辑，修复了部分浏览器下音效静音的问题。
- **UI/UX 去原生化 (HomeView)**：
  - 移除了所有原生的 `window.prompt` 和 `window.confirm`。
  - 新增 **`ManualRecordModal`**：手动录入生命体征的定制化模态框。
  - 新增 **`SOSConfirmModal`**：红黑配色的急救确认模态框，强化了紧急场景的视觉冲击力。
  - 优化了数据录入后的 Toast 反馈机制，形成完整的操作闭环。

### [2026-XX-XX] - [认知训练交互升级]
- **舒尔特方格优化**：
  1. **智能提示 (Smart Hint)**：新增 5 秒无操作检测，自动高亮下一个目标数字，有效降低 AD 患者的挫败感。
  2. **多感官反馈**：引入 Web Audio API，实现正确(Ding)/错误(Buzz)/升级(LevelUp)等即时音效，强化记忆训练闭环。
  3. **视觉增强**：在游戏顶部增加“当前目标”大字指示器，减轻患者的工作记忆负荷。

### [2026-XX-XX] - [MOH 风险模型升级]
- **医学规则优化**：
  1. **双重风险判定**：在 `DigitalPrescription.tsx` 中将 MOH（药物过度使用性头痛）的预警触发条件升级为“压力指数 > 80 或 生理周期 > 70”，涵盖了经期偏头痛的高发场景。
  2. **精准健康指导**：预警 Banner 增加了具体的用药频率限制建议（单纯止痛药 < 15天/月，曲普坦类 < 10天/月），符合 IHS 国际指南标准。
- **UI/UX**：优化了预警卡片的视觉层级，使用黄色警告色系及列表布局，提升信息可读性。

### [2026-XX-XX] - [安全合规与体验修复]
- **医疗安全**：
  1. **SOS 紧急呼救**：HomeView 新增红色悬浮球，支持一键拨打 120 (针对癫痫/高危用户)。
  2. **MOH 预警**：DigitalPrescription 新增药物过度使用智能提示，防止患者滥用止痛药。
  3. **免责声明**：首页底部显著位置添加医疗免责声明与隐私协议入口。
- **用户体验 (自愿原则)**：
  1. **柔性付费**：ChatView 移除了“强制模态框”，改为非阻塞式卡片，明确提供“免费跳过”按钮。
  2. **动态进度**：问诊进度条不再写死为 5 步，支持 AI 动态下发 totalSteps。
  3. **手动降级**：当 IoT 设备断连时，HomeView 允许用户手动录入心率数据，确保风控逻辑闭环。
- **隐私合规**：
  1. **ProfileView**：新增“隐私与授权管理”面板入口。

### [2026-XX-XX] - [工程化清理与文档规范化]
- **维护优化**：
  1. **服务层**：为 `geminiService.ts` 添加了 JSDoc 标准注释，详细说明了 CDSS 状态机、术语清洗及正则分诊策略。
  2. **状态层**：在 `AppContext.tsx` 中规范了 Reducer Actions 定义，增加了对“数据脱敏”和“家庭级联更新”的架构说明。
  3. **视图层**：对 `HomeView.tsx` 进行了区块化注释（金刚区、沉浸式顶栏），明确了视觉架构。
- **价值**：大幅提升了代码的可读性和可维护性，为团队协作和后续功能扩展（如真实 LLM 接入）奠定了坚实基础。

### [2026-XX-XX] - [亲情账号管理 CRUD]
- **业务改进**：
  1. **新增成员**：提供“添加家庭成员”模态框，支持选择头像、标签及录入姓名。
  2. **编辑与解绑**：支持对已绑定成员进行信息修改或解除绑定（含二次确认），满足家庭结构变更需求。
  3. **数据一致性**：解绑当前正在查看的家庭成员时，系统会自动回退到主账号视图，防止数据悬空。
- **医学/产品价值**：完善了“以家庭为单位”的慢病共管闭环，使得子女可以方便地为父母（或父母为子女）管理多个专病档案，符合真实医疗场景。
- **技术点**：`AppContext` 状态机增强，新增 `ADD`/`EDIT`/`REMOVE` actions。
- **遗留风险(Mock)**：无。

### [2026-XX-XX] - [支付系统健壮性升级]
- **业务改进**：
  1. **异常流程模拟**：支付网关 Mock 新增 20% 随机故障率，模拟网络超时/余额不足等真实场景。
  2. **Retry 机制**：支付失败页面新增“重新支付”按钮，允许用户原地重试，减少订单流失。
  3. **租赁收银台优化**：`HaaSRentalView` 同步接入异常处理分支，确保电商链路闭环。
- **医学/产品价值**：模拟真实网络环境下的交易流程，提升系统在弱网或异常情况下的用户体验，避免用户因支付卡顿而产生焦虑。
- **技术点**：`usePayment` Hook 状态机扩展，`PaywallModal` 新增 Error 视图。
- **遗留风险(Mock)**：无。

### [2026-XX-XX] - [问诊流程统一化重构]
- **业务改进**：
  1. **入口整合**：移除了顶部病种切换 Tab，整合为唯一的“AI 专病门诊”入口，简化用户决策路径。
  2. **智能分诊**：新增基于 NLU（模拟）的病种自动识别逻辑，AI 可根据用户描述（头痛、抽搐、忘事）自动路由至对应的 CDSS 临床路径。
  3. **交互优化**：在对话顶部增加了动态状态栏，实时显示当前接入的知识库类型（如由“通用”切换为“华西头痛中心”）。
- **医学/产品价值**：模拟真实线下门诊的“预检分诊”流程，避免患者因自我判断错误选择错误的专科，提升了医疗服务的专业性与准确性。
- **技术点**：`geminiService` 状态机重构，新增 `DiseaseType.UNKNOWN` 状态及正则路由表。
- **遗留风险(Mock)**：分诊逻辑目前基于简单的关键词正则匹配，生产环境需接入真实 NLP 模型。

**Date: 2024-05-22 (Init)**
*   **Action**: 项目文档初始化 (Project Documentation Initialization)。
*   **Status**: 基建完成。优化 Payment Gateway 的 Mock 逻辑，目前仅是 setTimeout，可以增加“支付失败/重试”的异常流程模拟，以满足更高健壮性要求。 ProfileView 的家庭成员管理逻辑细节，目前仅能查看，缺乏“新增/编辑/解绑”的完整 CRUD 交互，可进一步完善进行代码库清理与注释规范化，确保交付代码的可维护性
